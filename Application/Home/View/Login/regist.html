<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>注册</title>
    <link rel="stylesheet" href="__PUBLIC__/css/common.css">
    <style>
        .hint{
            display:inline-block;
            zoom: 1;
            *display: inline;
        }

        .wrong{
            color:#ff0000;
        }

        .right{
            color: #006400;
        }

    </style>
</head>
<body>
<div class="user-box-title">用户注册</div>
<form action="{:U('Login/registHandler')}" method="post">
    <div class="user-box-item">
        用户姓名
        <input name="username" id="username" onblur="checkUsername()"/>
        <div id="username_hint" class="hint"></div>
    </div>
    <div class="user-box-item">
        登录密码
        <input type="password" id="password" name="password" onblur="checkPassword()"/>
        <div id="password_hint"></div>
    </div>
    <div class="user-box-item">
        确认密码
        <input type="password" id="confirm_password" name="confirmPassword" onblur="checkConfirmPassword()"/>
        <div id="confirm_hint"></div>
    </div>
    <div class="user-box-item">
        <input type="button" id="regist_button" class="common-button" onclick="regist()" value="注册"/>
    </div>
</form>
<script src="__PUBLIC__/lib/jquery-1.7.2.min.js"></script>
<script src="__PUBLIC__/lib/layer/layer.js"></script>
<script src="__PUBLIC__/js/common/dialog.js"></script>
<script type="text/javascript">

    function checkUsername(){
        usernameHintDom = $('#username_hint');
        usernameHintDom.html("");
        usernameHintDom.removeClass();
        var username = $('#username').val();
        var patrn= /^[a-zA-Z1-9]{1}([a-zA-Z0-9]|[.@_]){4,19}$/;
        if(!patrn.exec(username)){
            dialog.error("用户名长度为5-20位,只能以字母或数字(1-9)开头、后可带数字、“_”、“.”、“@”");
            usernameHintDom.html("用户名非法");
            usernameHintDom.addClass("wrong");
            return;
        }
        $.ajax({
            url: "{:U('Api/User/checkUsername')}",
            data: {
                username: username,
                apikey:"{:C('API_ACCESS_KEY')}"
            },
            type: 'post',
            cache: false,
            dataType: 'json',
            success: function (data) {
                if (data.error_code) {
                    usernameHintDom.html(data.msg);
                    usernameHintDom.addClass("wrong");
                }else{
                    usernameHintDom.html("用户名可以使用");
                    usernameHintDom.addClass("right");
                }
            },
            error: function () {
                dialog.error("checkUsername:ajax请求失败!");
            }
        });

    }

    function regist(){
        var username = $('#username').val();
        var password = $('#password').val();
        var confirm_password = $("#confirm_password").val();
        var patrn= /^[a-zA-Z1-9]{1}([a-zA-Z0-9]|[.@_]){4,19}$/;
        if(!patrn.exec(username)){
            dialog.error("用户名长度为5-20位,只能以字母或数字(1-9)开头、后可带数字、“_”、“.”、“@”");
            return;
        }

        $.ajax({
            url: "{:U('Api/User/checkUsername')}",
            data: {
                username: username,
                apikey:"{:C('API_ACCESS_KEY')}"
            },
            type: 'post',
            cache: false,
            dataType: 'json',
            success: function (data) {
                if (data.error_code) {
                    dialog.error(data.msg);
                }else{
                    if( checkPassword() && checkConfirmPassword() ){
                        registHandler(username,password);
                    }
                }
            },
            error: function () {
                dialog.error("checkUsername:ajax请求失败!");
            }
        });

    }

    function checkPassword(){
        password = $("#password").val();
        passwordHintDom = $("#password_hint");
        passwordHintDom.html("");
        passwordHintDom.removeClass();
        var patrn = /^(\w){6,20}$/;
        if (!patrn.exec(password)){
            passwordHintDom.html("密码格式错误");
            passwordHintDom.addClass("wrong");
            dialog.error("密码须由6-20个字母、数字、下划线组成");
            return false;
        }
        return true;
    }

    function checkConfirmPassword(){
        password = $("#password").val();
        confirm_pwd = $("#confirm_password").val();
        confirmHintDom = $("#confirm_hint");
        confirmHintDom.html("");
        confirmHintDom.removeClass();
        if( password != confirm_pwd ){
            confirmHintDom.html("两次密码不一致");
            confirmHintDom.addClass("wrong");
            dialog.error("两次密码输入不一致");
            return false;
        }
        return true;
    }

    function registHandler(username,password){
        $.ajax({
            url: "{:U('Api/User/regist')}",
            data: {
                username: username,
                password:password,
                apikey:"{:C('API_ACCESS_KEY')}"
            },
            type: 'post',
            cache: false,
            dataType: 'json',
            success: function (data) {
                if (data.error_code) {
                    dialog.error(data.msg);
                }else{
                    dialog.success("注册成功!","{:U('Login/loginHandler', array('username'=>"+username+",'password'=>"+password+"))}");
                }
            },
            error: function () {
                dialog.error("checkUsername:ajax请求失败!");
            }
        });
    }


</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>重置密码</title>
    <link rel="stylesheet" href="__PUBLIC__/css/common.css">
</head>
<body>
    <div class="user-box-title">修改密码</div>
    <input type="hidden" id="username" value="{$username}"/>
    <div class="user-box-item">
        旧的密码
        <input type="password" id="old_password"/>
    </div>
    <div class="user-box-item">
        新的密码
        <input type="password" id="new_password"/>
    </div>
    <div class="user-box-item">
        确认密码
        <input type="password" id="confirm_password"/>
    </div>
    <div class="user-box-item">
        <input type="button" id="submit_button" class="common-button" value="修改密码" onclick="modify()"/>
    </div>

    <script src="__PUBLIC__/lib/jquery-1.7.2.min.js"></script>
    <script src="__PUBLIC__/lib/layer/layer.js"></script>
    <script src="__PUBLIC__/js/common/dialog.js"></script>

    <script type="text/javascript">

        function modify(){
            username = $('#username').val();
            oldPassword = $('#old_password').val();
            newPassword = $('#new_password').val();
            confirmPassword = $('#confirm_password').val();
            if( !oldPassword ){
                dialog.error("旧密码为空");
                return;
            }
            if( checkPassword(newPassword) ){
                if( newPassword != confirmPassword ){
                    dialog.error("两次密码输入不一致");
                    return;
                }
                $.ajax({
                    url: "{:U('Api/User/modifyPassword')}",
                    data: {
                        username: username,
                        oldPassword:oldPassword,
                        newPassword:newPassword,
                        apikey:"{:C('API_ACCESS_KEY')}"
                    },
                    type: 'post',
                    cache: false,
                    dataType: 'json',
                    success: function (data) {
                        if (data.error_code) {
                            dialog.error(data.msg);
                        }else{
                            dialog.success("修改密码成功!","{:U('Login/userCenter')}");
                        }
                    },
                    error: function () {
                        dialog.error("Api/User/modifyPassword:ajax请求失败!");
                    }
                });
            }
        }

        function checkPassword(password){
            passwordHintDom = $("#password_hint");
            passwordHintDom.html("");
            passwordHintDom.removeClass();
            var patrn = /^(\w){6,20}$/;
            if (!patrn.exec(password)){
                passwordHintDom.html("密码格式错误");
                passwordHintDom.addClass("wrong");
                dialog.error("密码须由6-20个字母、数字、下划线组成");
                return false;
            }
            return true;
        }

    </script>
</body>
</html>